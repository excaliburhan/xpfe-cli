#!/usr/bin/env node

var path = require('path')
var program = require('commander')
var inquirer = require('inquirer')
var download = require('download-git-repo')
var chalk = require('chalk')
var ora = require('ora')
var exists = require('fs').existsSync
var exec = require('child_process').exec
var rm = require('rimraf').sync
var file = require('../lib/file')
var tplJSON = require(file.filePath())

// help
function help () {
  program.parse(process.argv)
  if (program.args.length < 1) return program.help()
}

// run process
function run () {
  if (!hasSlash) {
    var downloadTemplate = 'xpfe-templates/' + templateName
    var url = tplJSON[templateName]
    if (url) { // custom
      if (url.indexOf('gitlab') > -1) { // just clone
        cloneTpl(url)
      } else {
        downloadTemplate = getRepoUrl(url)
        downloadTpl(downloadTemplate)
      }
    } else {
      downloadTpl(downloadTemplate)
    }
  } else {
    downloadTpl(templateName)
  }
}

// get github/gitlab repo url
function getRepoUrl(url) {
  var ret = url
  var index
  if (url.indexOf('github.com') > -1) {
    index = url.indexOf('github.com')
    ret = url.substring(index + 11, url.length - 4)
  }
  return ret
}

// download template
function downloadTpl(template) {
  var spinner = ora('Downloading template...')
  spinner.start()
  download(template, relativePath, function (err) {
    spinner.stop()
    console.log()
    if (err) {
      console.log(chalk.red(err))
      process.exit()
    }
    console.log(chalk.green('Create project success!'))
    process.exit()
  })
}

// git clone template
function cloneTpl(repoUrl) {
  var execCmd = 'git clone ' + repoUrl + ' ' + relativePath
  var spinner = ora('Downloading template...')
  spinner.start()
  exec(execCmd, (err, stdout, stderr) => {
    spinner.stop()
    console.log()
    if (err) {
      console.log(chalk.red(err))
      process.exit()
    }
    rm(relativePath + '.git') // 删除.git文件
    console.log(chalk.green('Create project success!'))
    process.exit()
  })
}

program
  .usage('<template-name> [project-name]')
  .on('--help', function () {
    console.log('  Examples:')
    console.log()
    console.log(chalk.gray('    # Create a new project with an template'))
    console.log('    $ xpfe init vue my-project')
    console.log()
    console.log(chalk.gray('    # Create a new project straight from a github repo'))
    console.log('    $ xpfe init username/repo my-project')
    console.log()
  })

help()

// get params
var templateName = program.args[0]
var dirName = program.args[1]
var hasSlash = templateName.indexOf('/') > -1
var isCurrent = !dirName || dirName === '.'
var relativePath = isCurrent ? path.relative('../', process.cwd()) : dirName
var filePath = path.resolve(dirName || '.')

console.log()
process.on('exit', function () {
  console.log()
})

// overwrite
if (exists(filePath)) {
  inquirer.prompt([
    {
      name: 'ok',
      type: 'confirm',
      message: isCurrent
        ? 'Create project in current directory?'
        : 'Target directory exists. Continue?'
    }
  ]).then(function (ans) {
    if (ans.ok) {
      if (!isCurrent) {
        rm(filePath)
      }
      run()
    }
  })
} else {
  run()
}
